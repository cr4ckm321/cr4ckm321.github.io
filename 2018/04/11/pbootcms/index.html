<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="vQAQv"><meta name="description" content="å–œæ¬¢ç”µå½±ï¼Œå–œæ¬¢ç¾é£Ÿï¼Œå–œæ¬¢æ—…æ¸¸ï¼Œä¹Ÿå–œæ¬¢ä½ ğŸ’–~"><link rel="icon" href="/favicon.png"><title>PbootCMS v0.9.8 åå° Getshell - vQAQv's blog | Just Do It!</title>
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">
<!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]-->
<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/fancybox/jquery.fancybox.min.js"></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="vQAQv's blog | Just Do It!" type="application/atom+xml">
</head><body style="opacity:1"><header class="head"><h1 class="head-title u-fl"><a href="/">vQAQv's blog | Just Do It!</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Archives</a></li><li class="head-nav__item"><a class="head-nav__link" href="/about">About Me</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-04-11T15:50:00.000Z">å››æœˆ 11, 2018</time><h1 class="post__title"><a href="/2018/04/11/pbootcms/">PbootCMS v0.9.8 åå° Getshell</a></h1><div class="post__main echo"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PBOOT CMS!æƒ³ä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</span><br><span class="line"></span><br><span class="line">PBOOT CMS!ä¸ºä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</span><br><span class="line"></span><br><span class="line">PBOOT CMS!åšä¼±æ‰€æƒ³,è®©ä¸€åˆ‡çš†æœ‰å¯èƒ½!</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>phpä»£ç å®¡è®¡çš„åˆå­¦è€…ï¼Œæ‰€ä»¥å°±å…ˆä»Dç±»CMSå…¥æ‰‹ã€‚</p>
<p>åå°é»˜è®¤è´¦å·ï¼š<code>admin</code> å¯†ç ï¼š<code>123456</code></p>
<p>ä»£ç å®¡è®¡åˆ†ï¼š</p>
<ul>
<li>å±é™©å‡½æ•°è¿½è¸ªæµ</li>
<li>é€šè¯»å…¨æ–‡æµ</li>
<li>é»‘ç™½ç›’ç»“åˆå®¡è®¡æµ</li>
</ul>
<h1 id="å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ"><a href="#å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ" class="headerlink" title="å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ"></a>å¼€å‘è€…æ ‡ç­¾æ‰‹å†Œ</h1><h2 id="IFæ¡ä»¶è¯­å¥"><a href="#IFæ¡ä»¶è¯­å¥" class="headerlink" title="IFæ¡ä»¶è¯­å¥"></a>IFæ¡ä»¶è¯­å¥</h2><ul>
<li><code>æ³¨æ„ï¼šæ¡ä»¶è¯­å¥ä¸­å­—ç¬¦ä¸²éœ€è¦ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œæ¡ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”ŸPHPä»£ç ï¼› æ‰€æœ‰å¯¹å…¶å®ƒæ ‡ç­¾çš„è°ƒç”¨éƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åŠ å•å¼•å·ã€‚</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">&#x27;a&#x27;</span>==<span class="string">&#x27;b&#x27;</span>)&#125;</span><br><span class="line">	å†…å®¹<span class="number">1</span></span><br><span class="line">&#123;<span class="keyword">else</span>&#125;</span><br><span class="line">	å†…å®¹<span class="number">2</span></span><br><span class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¤ºä¾‹ä¸€ï¼šåœ¨IFä¸­ä½¿ç”¨PHPå‡½æ•°ç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;pboot:<span class="keyword">if</span>(date(<span class="string">&#x27;Y&#x27;</span>)==<span class="number">2018</span>)&#125;<span class="number">2018</span>å¹´&#123;/pboot:<span class="keyword">if</span>&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹äºŒï¼šé«˜äº®æ ç›®ç¤ºä¾‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">nav</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">dl</span>&gt;</span></span><br><span class="line"><span class="class">     &lt;<span class="title">dt</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;</span>&#123;pboot:sitepath&#125;/<span class="string">&quot; &#123;pboot:if(0==&#x27;&#123;sort:scode&#125;&#x27;)&#125;class=&#x27;active&#x27;&#123;/pboot:if&#125;&gt;é¦–é¡µ&lt;/a&gt;&lt;/dt&gt;</span></span><br><span class="line"><span class="string">&lt;/dl&gt;</span></span><br><span class="line"><span class="string">&#123;pboot:nav parent=0&#125;</span></span><br><span class="line"><span class="string">&lt;dl&gt;</span></span><br><span class="line"><span class="string">	&lt;dt&gt;&lt;a href=&quot;</span>[nav:link]<span class="string">&quot; &#123;pboot:if(&#x27;[nav:scode]&#x27;==&#x27;&#123;sort:tcode&#125;&#x27;)&#125;class=&#x27;active&#x27;&#123;/pboot:if&#125;&gt;[nav:name]&lt;/a&gt;&lt;/dt&gt;</span></span><br><span class="line"><span class="string">	&lt;dd&gt;</span></span><br><span class="line"><span class="string">	&#123;pboot:2nav parent=[nav:scode]&#125;</span></span><br><span class="line"><span class="string">		&lt;a href=&quot;</span>[<span class="number">2</span>nav:link]<span class="string">&quot;  &#123;pboot:if(&#x27;[2nav:scode]&#x27;==&#x27;&#123;sort:scode&#125;&#x27;)&#125;class=&#x27;active&#x27;&#123;/pboot:if&#125;&gt;[2nav:name]&lt;/a&gt; |</span></span><br><span class="line"><span class="string">	&#123;/pboot:2nav&#125;</span></span><br><span class="line"><span class="string">	&lt;/dd&gt;</span></span><br><span class="line"><span class="string">&lt;/dl&gt;</span></span><br><span class="line"><span class="string">&#123;/pboot:nav&#125;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>ç¤ºä¾‹ä¸‰ï¼šåµŒå¥—IFï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;pboot:<span class="keyword">if</span>(<span class="string">&#x27;a&#x27;</span>==<span class="string">&#x27;b&#x27;</span>)&#125;</span><br><span class="line">	&#123;pboot:<span class="number">2</span><span class="keyword">if</span>(<span class="string">&#x27;a&#x27;</span>==<span class="string">&#x27;b&#x27;</span>)&#125;</span><br><span class="line">		å†…å®¹<span class="number">1</span></span><br><span class="line">	&#123;<span class="number">2</span><span class="keyword">else</span>&#125;</span><br><span class="line">		å†…å®¹<span class="number">2</span></span><br><span class="line">	&#123;/pboot:<span class="number">2</span><span class="keyword">if</span>&#125;</span><br><span class="line">&#123;<span class="keyword">else</span>&#125;</span><br><span class="line">	å†…å®¹<span class="number">3</span></span><br><span class="line">&#123;/pboot:<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>è¿™é‡Œè¯´äº†å¯æ‰§è¡ŒPHPè¯­å¥ï¼Œä½†è¦æ’åœ¨<code>IFæ¡ä»¶æ ‡ç­¾</code>ï¼Œä¾‹å¦‚ï¼š</p>
<p><code>&#123;pboot:if(phpè¯­å¥)&#125;Â &#123;/pboot:if&#125;</code></p>
<p>ç„¶åå†è¿”å›æ–‡ä»¶æŸ¥çœ‹æºä»£ç æ–‡ä»¶ï¼š</p>
<p>è¯¥æ–‡ä»¶æ˜¯ï¼šæ ‡ç­¾è§£æå¼•æ“æ§åˆ¶å™¨ï¼Œä¹Ÿå°±æ˜¯è§£ææ ‡ç­¾çš„ã€‚</p>
<p>ä»£ç çš„<code>1273~1314</code>ä¸ºå…³äºIFæ¡ä»¶è¯­å¥çš„ã€‚</p>
<p><code>/apps/home/controller/ParserController.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£æIFæ¡ä»¶æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern2</span> = <span class="string">&#x27;/pboot:([0-9])+if/&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="variable">$pattern</span>, <span class="variable">$content</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">        <span class="variable">$count</span> = count(<span class="variable">$matches</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$count</span>; <span class="variable">$i</span> ++) &#123;</span><br><span class="line">            <span class="variable">$flag</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$out_html</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&#x27;if(&#x27;</span> . <span class="variable">$matches</span>[<span class="number">1</span>][<span class="variable">$i</span>] . <span class="string">&#x27;)&#123;$flag=&quot;if&quot;;&#125;else&#123;$flag=&quot;else&quot;;&#125;&#x27;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/&#x27;</span>, <span class="variable">$matches</span>[<span class="number">2</span>][<span class="variable">$i</span>], <span class="variable">$matches2</span>)) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨else</span></span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$flag</span>) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;if&#x27;</span>: <span class="comment">// æ¡ä»¶ä¸ºçœŸ</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$matches2</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                            <span class="variable">$out_html</span> = <span class="variable">$matches2</span>[<span class="number">1</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;else&#x27;</span>: <span class="comment">// æ¡ä»¶ä¸ºå‡</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$matches2</span>[<span class="number">2</span>])) &#123;</span><br><span class="line">                            <span class="variable">$out_html</span> = <span class="variable">$matches2</span>[<span class="number">2</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="variable">$flag</span> == <span class="string">&#x27;if&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable">$out_html</span> = <span class="variable">$matches</span>[<span class="number">2</span>][<span class="variable">$i</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ— é™æåµŒå¥—è§£æ</span></span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="variable">$pattern2</span>, <span class="variable">$out_html</span>, <span class="variable">$matches3</span>)) &#123;</span><br><span class="line">                <span class="variable">$out_html</span> = str_replace(<span class="string">&#x27;pboot:&#x27;</span> . <span class="variable">$matches3</span>[<span class="number">1</span>] . <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;pboot:if&#x27;</span>, <span class="variable">$out_html</span>);</span><br><span class="line">                <span class="variable">$out_html</span> = str_replace(<span class="string">&#x27;&#123;&#x27;</span> . <span class="variable">$matches3</span>[<span class="number">1</span>] . <span class="string">&#x27;else&#125;&#x27;</span>, <span class="string">&#x27;&#123;else&#125;&#x27;</span>, <span class="variable">$out_html</span>);</span><br><span class="line">                <span class="variable">$out_html</span> = <span class="keyword">$this</span>-&gt;parserIfLabel(<span class="variable">$out_html</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ›¿æ¢</span></span><br><span class="line">            <span class="variable">$content</span> = str_replace(<span class="variable">$matches</span>[<span class="number">0</span>][<span class="variable">$i</span>], <span class="variable">$out_html</span>, <span class="variable">$content</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®åœ¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pattern</span> = <span class="string">&#x27;/\&#123;pboot:if\(([^&#125;]+)\)\&#125;([\s\S]*?)\&#123;\/pboot:if\&#125;/&#x27;</span>;</span><br><span class="line"><span class="variable">$pattern2</span> = <span class="string">&#x27;/pboot:([0-9])+if/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match_all(<span class="variable">$pattern</span>, <span class="variable">$content</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">    <span class="variable">$count</span> = count(<span class="variable">$matches</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$count</span>; <span class="variable">$i</span> ++) &#123;</span><br><span class="line">        <span class="variable">$flag</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$out_html</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;if(&#x27;</span> . <span class="variable">$matches</span>[<span class="number">1</span>][<span class="variable">$i</span>] . <span class="string">&#x27;)&#123;$flag=&quot;if&quot;;&#125;else&#123;$flag=&quot;else&quot;;&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>åªç»è¿‡ç®€å•çš„æ­£åˆ™åŒ¹é…ä¹‹åå°±èµ‹å€¼ï¼Œç„¶å<code>eval()</code>æ‰§è¡Œã€‚</p>
<p>åˆ°æ­¤éœ€è¦å¯»åœ¨åˆ©ç”¨ç‚¹ã€‚</p>
<h1 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h1><p>Poc:</p>
<p><code>&#123;pboot:if(phpinfo())&#125;!&#123;/pboot:if&#125;</code></p>
<p>æœ€åç»è¿‡å¯»æ‰¾ï¼Œåªè¦å‘ç°åå°èƒ½ç¼–è¾‘çš„åœ°æ–¹ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½æ’å…¥<code>IFæ¡ä»¶è¯­å¥æ ‡ç­¾</code>å¹¶èƒ½è§£ææ‰§è¡Œã€‚</p>
<p><img src="/image/pbootcms/poc.png" alt="poc.png"></p>
<p>è®¿é—®é¦–é¡µå°±å¯ä»¥çœ‹åˆ°<code>phpinfo</code>é¡µé¢</p>
<p><img src="/image/phpinfo.png" alt="phpinfo.png"></p>
<p>ç„¶åå°è¯•äº†å¤šæ¬¡å¤šç‚¹å‡èƒ½Getshell.</p>
<h1 id="å¦å¤–"><a href="#å¦å¤–" class="headerlink" title="å¦å¤–"></a>å¦å¤–</h1><p>å‰å°æŸå¤„å­˜åœ¨CSRFï¼Œåˆ©ç”¨å…¶ä¿®æ”¹åå°å†…å®¹ï¼Œä½†å‡æœ‰æå‡<code>ä¿®æ”¹æˆåŠŸ</code>çš„é¡µé¢ï¼Œåšä¸åˆ°æ— æ„ŸçŸ¥ä¿®æ”¹å†…å®¹ï¼Œå› æ­¤<code>CSRF+IFæ¡ä»¶è¯­å¥æ ‡ç­¾</code>ä¹Ÿæ˜¯æ¯”è¾ƒé¸¡è‚‹ã€‚</p>
<p><img src="/image/pbootcms/mod.png" alt="mod.png"></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/ä»£ç å®¡è®¡/">ä»£ç å®¡è®¡</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/CMS/">CMS</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">Contact me</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="å¾®ä¿¡"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016-2021 vQAQv</div></footer>
<script src="/js/scroller.js"></script>

<script src="/js/main.js"></script>
</body></html>